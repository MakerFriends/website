---
// Newsletter Signup Component
// Primary: Buttondown (recommended for developer-friendly newsletters)
// Fallback: Formspree, Mailchimp, ConvertKit
//
// Setup Instructions:
// 1. Create account at buttondown.email
// 2. Get your API key from Settings > API
// 3. Replace YOUR_BUTTONDOWN_API_KEY with your actual key
// 4. Test the integration
---

<div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white py-12 px-4 sm:px-6 lg:px-8">
  <div class="max-w-4xl mx-auto text-center">
    <h2 class="text-3xl font-bold mb-4">Stay Connected with MakerFriends</h2>
    <p class="text-xl mb-8 text-blue-100">
      Get the latest updates on MakerSpaces, projects, and community events delivered to your inbox.
    </p>

    <!-- Newsletter Form -->
    <form id="newsletterForm" class="max-w-md mx-auto">
      <div class="flex flex-col sm:flex-row gap-3">
        <input
          type="email"
          name="email"
          id="newsletterEmail"
          placeholder="Enter your email address"
          required
          class="flex-1 px-4 py-3 rounded-lg text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-300"
        />
        <button
          type="submit"
          class="px-8 py-3 bg-white text-blue-600 font-semibold rounded-lg hover:bg-blue-50 transition-colors">
          Subscribe
        </button>
      </div>

      <!-- GDPR Compliance Section -->
      <div class="mt-4 text-left">
        <div class="flex items-start gap-3">
          <input
            type="checkbox"
            id="gdprConsent"
            name="gdprConsent"
            required
            class="mt-1 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2"
          />
          <label for="gdprConsent" class="text-sm text-blue-200 leading-relaxed">
            I consent to receiving newsletters from MakerFriends. I understand that I can unsubscribe at any time.
            <a href="/privacy" class="underline hover:text-white" target="_blank">Privacy Policy</a>
          </label>
        </div>

        <div class="mt-3 text-xs text-blue-300">
          <strong>Data Processing:</strong> We use Buttondown to manage our newsletter. Your email and subscription preferences
          are stored securely. We may track open rates and click-through rates to improve our content.
          <a href="/privacy#data-processing" class="underline hover:text-white" target="_blank"
            >Learn more about data processing</a
          >.
        </div>
      </div>
    </form>

    <!-- Success/Error Messages -->
    <div id="newsletterMessage" class="mt-4 hidden">
      <div id="successMessage" class="hidden text-green-200 bg-green-800/30 rounded-lg p-3">
        ✅ Thanks for subscribing! Check your email to confirm.
      </div>
      <div id="errorMessage" class="hidden text-red-200 bg-red-800/30 rounded-lg p-3">
        ❌ Something went wrong. Please try again.
      </div>
    </div>
  </div>
</div>

<script>
  document.getElementById("newsletterForm")?.addEventListener("submit", async function (e) {
    e.preventDefault();

    const form = e.target as HTMLFormElement;
    if (!form) return;

    const email = form.email.value;
    const gdprConsent = form.gdprConsent.checked;
    const messageDiv = document.getElementById("newsletterMessage");
    const successDiv = document.getElementById("successMessage");
    const errorDiv = document.getElementById("errorMessage");

    // GDPR Compliance Check
    if (!gdprConsent) {
      alert("Please provide consent to receive newsletters by checking the consent checkbox.");
      return;
    }

    // Hide previous messages
    messageDiv?.classList.remove("hidden");
    successDiv?.classList.add("hidden");
    errorDiv?.classList.add("hidden");

    try {
      // Primary: Buttondown API (recommended for developer-friendly newsletters)
      await subscribeToButtondown(email, gdprConsent);

      successDiv?.classList.remove("hidden");
      form.reset();
    } catch {
      // console.error("Newsletter signup error:", error);

      // Fallback options (uncomment as needed):
      // await subscribeToFormspree(email);
      // await subscribeToMailchimp(email);
      // await subscribeToConvertKit(email);

      errorDiv?.classList.remove("hidden");
    }
  });

  // Buttondown Integration (recommended for developer-friendly newsletters)
  async function subscribeToButtondown(email: string, gdprConsent: boolean) {
    const BUTTONDOWN_API_KEY = "YOUR_BUTTONDOWN_API_KEY";

    const response = await fetch("https://api.buttondown.email/v1/subscribers", {
      method: "POST",
      headers: {
        Authorization: `Token ${BUTTONDOWN_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        email: email,
        referrer_url: window.location.href,
        tags: ["makerfriends", "website-signup", "gdpr-consent"],
        notes: `Subscribed from MakerFriends website on ${new Date().toISOString()}. GDPR Consent: ${gdprConsent ? "Yes" : "No"}`,
        metadata: {
          gdpr_consent: gdprConsent,
          consent_timestamp: new Date().toISOString(),
          consent_source: "website_signup_form",
          ip_address: "anonymized", // Note: IP should be anonymized in production
        },
      }),
    });

    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(`Buttondown subscription failed: ${errorData.detail || "Unknown error"}`);
    }

    return response.json();
  }

  // Fallback integrations (commented out - uncomment and configure as needed)
  // async function subscribeToFormspree(email) { ... }
  // async function subscribeToMailchimp(email) { ... }
  // async function subscribeToConvertKit(email) { ... }
</script>
